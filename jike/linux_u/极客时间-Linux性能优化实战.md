#Linux性能优化实战


## CPU性能篇

### 如何理解平均负载

1. 平均负载：单位时间内，系统处于`可运行状态`和`不可中断状态`的平均进程数，也就是`平均活跃进程数`。
2. 可运行状态：正在使用CPU或者正在等待CPU的进程。ps命令处于R状态的进程。
3. 不可中断状态：进程处于内核关键流程，不可打断。ps命令处于D状态。如，一个向一个磁盘的写数据的操作，为了保证数据一致性，在得到磁盘回复前，不可被打断。
4. 不可中断状态是对系统进程和硬件设备的保护机制。
5. 查看系统cpu信息：`/proc/cpuinfo`
6. 当平均负载高于CPU数量的70%时候，需要排查。
7. 平均负载包括了可运行和不可中断进程，所以其包括了CPU进程和等待CPU和等待IO的进程。
8. CPU密集型进程，会使CPU利用率和平均负载升高；IO密集型，会使平均负载升高，但是CPU利用率不一定高。
9. mpstat：多核CPU性能分析工具，实时查看所有CPU性能指标。
10. pidstat: 进程分析工具，实时查看进程的CPU,内存，io和上线文切换等指标。

场景1

1. stress --cpu 1 --tomeout 600 模拟cpu压力
2. watch -d uptime  查看平均负载变化
3. mpstat  -P ALL 2  查看CPU使用率   
4. pidstat -u 1   查看那个进程导致  


### CPU上线文切换（上）

1. CPU寄存器是CPU内置的容量小、速度快的内存；程序计数器，用来存储CPU正在执行的指令位置或下一条位置。是CPU运行任务的前提，称为CPU的上下文。
2. 进程上下文切换：进程在CPU在系统调用和用户态的切换。一次系统条用，发生两次CPU上下文切换。同一个进程，只是发生系统调用和用户态调用的切换。
3. 进程上下文切换：进程时间片结束，会被挂起，进行切换；进程资源不足，被挂起；sleep函数，挂起；优先级造成的挂起；硬中断挂起。
4. 线程上下文：不通进程的线程的切换；同一个进程的不同线程的私有数据的切换。影响较小
5. 中断上下文切换：为了快速响应硬件的中断，会打断正常的进程调度。对内核态数据有影响。
6. 中断优先级比进程更高。




